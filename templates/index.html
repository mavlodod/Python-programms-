<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>üéÇ –£—á–µ—Ç –¥–Ω–µ–π —Ä–æ–∂–¥–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .card-custom {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card-custom:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .birthday-today {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%) !important;
            border-left: 5px solid var(--warning-color) !important;
        }

        .birthday-tomorrow {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%) !important;
            border-left: 5px solid var(--primary-color) !important;
        }

        .employee-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }

        .action-buttons .btn {
            margin: 0 3px;
            border-radius: 8px;
            padding: 5px 12px;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .btn-edit {
            background-color: var(--warning-color);
            border-color: var(--warning-color);
            color: white;
        }

        .btn-edit:hover {
            background-color: #d68910;
            border-color: #d68910;
        }

        .btn-delete {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
            color: white;
        }

        .btn-delete:hover {
            background-color: #c0392b;
            border-color: #c0392b;
        }

        .search-box {
            max-width: 300px;
            border-radius: 25px;
            border: 2px solid #e0e0e0;
            padding-left: 40px;
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .stats-card {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            color: white;
            margin-bottom: 20px;
        }

        .stats-card.total {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }

        .stats-card.today {
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
        }

        .stats-card.tomorrow {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stats-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .badge-birthday {
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            color: #333;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 500;
        }

        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .notification-controls {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .birthday-message {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }

        .birthday-message.show { display: block; animation: fadeIn 0.5s; }

        .age-badge {
            background-color: #e1f5fe;
            color: #0277bd;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(102, 126, 234, 0.05);
            cursor: pointer;
        }

        .table-selected {
            background-color: rgba(102, 126, 234, 0.1) !important;
        }
    </style>
</head>

<body>
<div class="container-fluid py-4">

    <!-- –®–∞–ø–∫–∞ -->
    <div class="dashboard-header">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="display-5 fw-bold mb-2">
                    <i class="bi bi-balloon-heart"></i> –£—á–µ—Ç –¥–Ω–µ–π —Ä–æ–∂–¥–µ–Ω–∏—è
                </h1>
                <p class="lead mb-0">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <strong class="text-warning">{{ username }}</strong>!</p>
            </div>

            <div class="col-md-6 text-end">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-light" onclick="sendTestNotification()">
                        <i class="bi bi-bell"></i> –¢–µ—Å—Ç Telegram
                    </button>
                    <a href="{{ url_for('check_birthdays_manual') }}" class="btn btn-outline-light">
                        <i class="bi bi-calendar-check"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –î–†
                    </a>
                    {% if is_admin %}
                    <a href="{{ url_for('departments') }}" class="btn btn-outline-light ms-2">
                        <i class="bi bi-diagram-3"></i> –û—Ç–¥–µ–ª—ã
                    </a>
                    <a href="{{ url_for('users') }}" class="btn btn-outline-light ms-2">
                        <i class="bi bi-people"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                    </a>
                    {% endif %}
                    <a href="{{ url_for('logout') }}" class="btn btn-danger ms-2">
                        <i class="bi bi-box-arrow-right"></i> –í—ã–π—Ç–∏
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Flash —Å–æ–æ–±—â–µ–Ω–∏—è -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="row">
                <div class="col-12">
                    {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm fade-in" role="alert">
                        <i class="bi bi-{% if category == 'success' %}check-circle{% elif category == 'danger' %}exclamation-triangle{% elif category == 'warning' %}exclamation-circle{% else %}info-circle{% endif %} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    {% endwith %}

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="stats-card total">
                <div class="stats-number">{{ employees|length }}</div>
                <div class="stats-label">–í—Å–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
                <i class="bi bi-people-fill" style="font-size: 2rem; opacity: 0.7;"></i>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card today">
                <div class="stats-number">{{ birthdays_today|length }}</div>
                <div class="stats-label">–î–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è</div>
                <i class="bi bi-gift-fill" style="font-size: 2rem; opacity: 0.7;"></i>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card tomorrow">
                <div class="stats-number">{{ birthdays_tomorrow|length }}</div>
                <div class="stats-label">–î–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è –∑–∞–≤—Ç—Ä–∞</div>
                <i class="bi bi-calendar-heart-fill" style="font-size: 2rem; opacity: 0.7;"></i>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
        <div class="col-lg-4">

            <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
            <div class="card card-custom">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0" id="formTitle">
                        <i class="bi bi-person-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="employeeForm">
                        <input type="hidden" name="action" value="add_employee">
                        <input type="hidden" id="employeeId" name="employee_id" value="">

                        <div class="mb-3">
                            <label for="employeeName" class="form-label">
                                <i class="bi bi-person-badge"></i> –ò–º—è –∏ –§–∞–º–∏–ª–∏—è
                            </label>
                            <input type="text" class="form-control" id="employeeName" name="name"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞" required>
                        </div>

                        <div class="mb-3">
                            <label for="employeeDob" class="form-label">
                                <i class="bi bi-calendar-date"></i> –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è
                            </label>
                            <input type="date" class="form-control" id="employeeDob" name="dob" required>
                        </div>

                        <div class="mb-3">
                            <label for="employeeDept" class="form-label">
                                <i class="bi bi-diagram-3"></i> –û—Ç–¥–µ–ª
                            </label>
                            <select class="form-select" id="employeeDept" name="department_id">
                                <option value="">‚Äî –±–µ–∑ –æ—Ç–¥–µ–ª–∞ ‚Äî</option>
                                {% for d in departments %}
                                    <option value="{{ d[0] }}">{{ d[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-success" id="submitBtn">
                                <i class="bi bi-check-circle"></i> –î–æ–±–∞–≤–∏—Ç—å
                            </button>
                            <button type="button" class="btn btn-warning" id="updateBtn" style="display: none;">
                                <i class="bi bi-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                            </button>
                            <button type="button" class="btn btn-secondary" id="cancelBtn" style="display: none;">
                                <i class="bi bi-x-circle"></i> –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
            <div class="notification-controls">
                <h6><i class="bi bi-bell"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏</h6>
                <div class="btn-group w-100 mt-2" role="group">
                    <a href="{{ url_for('check_birthdays_manual') }}" class="btn btn-outline-primary">
                        <i class="bi bi-send-check"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é
                    </a>
                    <button type="button" class="btn btn-outline-success" onclick="sendTestNotification()">
                        <i class="bi bi-bell"></i> –¢–µ—Å—Ç
                    </button>
                </div>
            </div>

            <!-- –ë–ª–∏–∂–∞–π—à–∏–µ -->
            {% if birthdays_today or birthdays_tomorrow %}
            <div class="card card-custom">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-gift"></i> –ë–ª–∏–∂–∞–π—à–∏–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏</h5>
                </div>
                <div class="card-body">
                    {% if birthdays_today %}
                    <div class="alert alert-success">
                        <h6><i class="bi bi-emoji-smile"></i> –°–µ–≥–æ–¥–Ω—è:</h6>
                        <ul class="list-unstyled mb-0">
                            {% for name in birthdays_today %}
                            <li class="mb-1">
                                <i class="bi bi-balloon"></i> {{ name }}
                                <span class="badge-birthday float-end">–°–µ–π—á–∞—Å!</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if birthdays_tomorrow %}
                    <div class="alert alert-info">
                        <h6><i class="bi bi-alarm"></i> –ó–∞–≤—Ç—Ä–∞:</h6>
                        <ul class="list-unstyled mb-0">
                            {% for name in birthdays_tomorrow %}
                            <li class="mb-1">
                                <i class="bi bi-calendar-plus"></i> {{ name }}
                                <span class="badge bg-primary float-end">–ó–∞–≤—Ç—Ä–∞</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
        <div class="col-lg-8">

            <div class="card card-custom mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="input-group position-relative">
                                <span class="input-group-text search-icon">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text" id="searchInput" class="form-control search-box"
                                       placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏...">
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary me-2" onclick="toggleEmployeeList()">
                                <i class="bi bi-list"></i>
                                <span id="toggleText">–°–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫</span>
                            </button>
                            <button class="btn btn-danger" onclick="deleteSelected()">
                                <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (–®–∞–ø–∫–∞ = –∫–Ω–æ–ø–∫–∏ –æ—Ç–¥–µ–ª–æ–≤) -->
            <div class="card card-custom" id="employeeListCard">
                <div class="card-header bg-secondary text-white">
                    <div class="d-flex flex-wrap align-items-center gap-2">
                        <div class="me-2 text-white fw-semibold">
                            <i class="bi bi-diagram-3"></i> –û—Ç–¥–µ–ª—ã:
                        </div>

                        <button type="button" class="btn btn-sm btn-light" onclick="filterByDepartment('ALL')">
                            –í—Å–µ
                            <span class="badge bg-dark ms-1" id="countAll">{{ employees|length }}</span>
                        </button>

                        <div id="deptButtons" class="d-flex flex-wrap gap-2"></div>

                        <div class="ms-auto text-white">
                            <span class="badge bg-light text-dark" id="currentFilterLabel">–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</span>
                        </div>
                    </div>
                </div>

                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                            <tr>
                                <th width="50" class="text-center">
                                    <input type="checkbox" id="selectAll" class="form-check-input">
                                </th>
                                <th width="60">#</th>
                                <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                                <th>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th>
                                <th>–í–æ–∑—Ä–∞—Å—Ç</th>
                                <th>–û—Ç–¥–µ–ª</th>
                                <th class="text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                            </thead>

                            <tbody id="employeeTableBody">
                            {% for emp in employees %}
                                {% set birth_date = emp.dob.split('-') %}
                                {% set birth_year = birth_date[0]|int %}
                                {% set birth_month = birth_date[1]|int %}
                                {% set birth_day = birth_date[2]|int %}

                                {% set age = now.year - birth_year %}
                                {% if now.month < birth_month or (now.month == birth_month and now.day < birth_day) %}
                                    {% set age = age - 1 %}
                                {% endif %}

                                <tr data-id="{{ emp.id }}"
                                    class="employee-row {% if emp.name in birthdays_today %}birthday-today{% elif emp.name in birthdays_tomorrow %}birthday-tomorrow{% endif %}">
                                    <td class="text-center">
                                        <input type="checkbox" class="form-check-input employee-checkbox"
                                               value="{{ emp.id }}">
                                    </td>
                                    <td>{{ loop.index }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="employee-avatar me-3">
                                                {{ emp.name.split(' ')[0][0] }}{% if emp.name.split(' ')|length > 1 %}{{ emp.name.split(' ')[-1][0] }}{% else %}{{ emp.name[0] }}{% endif %}
                                            </div>
                                            <div>
                                                <strong>{{ emp.name }}</strong>
                                                {% if emp.name in birthdays_today %}
                                                <span class="badge bg-danger ms-2">–î–† –°–ï–ì–û–î–ù–Ø!</span>
                                                {% elif emp.name in birthdays_tomorrow %}
                                                <span class="badge bg-warning ms-2">–î–† –ó–ê–í–¢–†–ê</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {{ "%02d"|format(birth_day) }}.{{ "%02d"|format(birth_month) }}.{{ birth_year }}
                                        <br>
                                        <small class="text-muted">{{ emp.dob }}</small>
                                    </td>
                                    <td>
                                        <span class="age-badge">{{ age }} {{ get_age_suffix(age) }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark">
                                            {{ emp.department if emp.department else "‚Äî" }}
                                        </span>
                                    </td>
                                    <td class="text-center action-buttons">
                                        <button class="btn btn-sm btn-edit" onclick="editEmployee({{ emp.id }})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-delete" onclick="deleteEmployee({{ emp.id }})" title="–£–¥–∞–ª–∏—Ç—å">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        <button class="btn btn-sm btn-info" onclick="viewEmployee({{ emp.id }}, '{{ emp.name }}', '{{ emp.dob }}', '{{ emp.department|default("") }}')" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            {% if birthdays_today %}
            <div class="birthday-message show">
                <div class="alert alert-success border-0">
                    <h5><i class="bi bi-gift-fill"></i> –°–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è!</h5>
                    <p class="mb-2">–ü–æ–∑–¥—Ä–∞–≤—å—Ç–µ —ç—Ç–∏—Ö –∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–ª–ª–µ–≥:</p>
                    <ul>
                        {% for name in birthdays_today %}
                        <li><strong>{{ name }}</strong> - —Å–µ–≥–æ–¥–Ω—è –ø—Ä–∞–∑–¥–Ω—É–µ—Ç —Å–≤–æ–π –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è!</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ -->
<div class="modal fade" id="viewEmployeeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="employeeDetails"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button type="button" class="btn btn-primary" id="editFromModal">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
let editingEmployeeId = null;

function getAgeSuffix(age) {
    if (11 <= age % 100 && age % 100 <= 19) return "–ª–µ—Ç";
    if (age % 10 === 1) return "–≥–æ–¥";
    if (2 <= age % 10 && age % 10 <= 4) return "–≥–æ–¥–∞";
    return "–ª–µ—Ç";
}

function toggleEmployeeList() {
    const card = document.getElementById('employeeListCard');
    const toggleText = document.getElementById('toggleText');
    if (card.style.display === 'none') {
        card.style.display = 'block';
        toggleText.textContent = '–°–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫';
    } else {
        card.style.display = 'none';
        toggleText.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫';
    }
}

document.getElementById('searchInput').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    document.querySelectorAll('#employeeTableBody tr').forEach(row => {
        const name = row.querySelector('td:nth-child(3) strong').textContent.toLowerCase();
        row.style.display = name.includes(searchTerm) ? '' : 'none';
    });
});

document.getElementById('selectAll').addEventListener('change', function(e) {
    document.querySelectorAll('.employee-checkbox').forEach(cb => {
        cb.checked = e.target.checked;
        const row = cb.closest('tr');
        cb.checked ? row.classList.add('table-selected') : row.classList.remove('table-selected');
    });
});

document.querySelectorAll('.employee-checkbox').forEach(cb => {
    cb.addEventListener('change', function() {
        const row = this.closest('tr');
        this.checked ? row.classList.add('table-selected') : row.classList.remove('table-selected');
    });
});

/* === –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ === */
function editEmployee(id) {
    editingEmployeeId = id;
    axios.get(`/get_employee/${id}`)
        .then(res => {
            const emp = res.data;
            document.getElementById('employeeId').value = emp.id;
            document.getElementById('employeeName').value = emp.name;
            document.getElementById('employeeDob').value = emp.dob;

            const deptSelect = document.getElementById('employeeDept');
            if (deptSelect) deptSelect.value = emp.department_id ? String(emp.department_id) : "";

            document.getElementById('formTitle').innerHTML = '<i class="bi bi-person-check"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞';
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('updateBtn').style.display = 'inline-block';
            document.getElementById('cancelBtn').style.display = 'inline-block';
            document.getElementById('employeeForm').scrollIntoView({behavior:'smooth'});
        })
        .catch(() => alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞'));
}

document.getElementById('updateBtn').addEventListener('click', function() {
    const form = document.getElementById('employeeForm');
    const fd = new FormData(form);
    fd.set('action', 'update_employee');
    fetch('/update_employee', { method:'POST', body: fd })
        .then(r => r.ok ? window.location.reload() : alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏'))
        .catch(() => alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'));
});

document.getElementById('cancelBtn').addEventListener('click', resetForm);

function resetForm() {
    editingEmployeeId = null;
    document.getElementById('employeeId').value = '';
    document.getElementById('employeeName').value = '';
    document.getElementById('employeeDob').value = '';
    document.getElementById('employeeDept').value = '';

    document.getElementById('formTitle').innerHTML = '<i class="bi bi-person-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞';
    document.getElementById('submitBtn').style.display = 'inline-block';
    document.getElementById('updateBtn').style.display = 'none';
    document.getElementById('cancelBtn').style.display = 'none';
}

/* === –£–¥–∞–ª–µ–Ω–∏–µ === */
function deleteEmployee(id) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?')) return;
    const fd = new FormData();
    fd.append('delete_ids', id);
    fetch('/delete_employees', { method:'POST', body: fd })
        .then(r => r.ok ? window.location.reload() : alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏'));
}

function deleteSelected() {
    const selected = document.querySelectorAll('.employee-checkbox:checked');
    if (selected.length === 0) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤');
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö (${selected.length})?`)) return;

    const fd = new FormData();
    selected.forEach(cb => fd.append('delete_ids', cb.value));
    fetch('/delete_employees', { method:'POST', body: fd })
        .then(r => r.ok ? window.location.reload() : alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏'));
}

/* === –ü—Ä–æ—Å–º–æ—Ç—Ä === */
function calculateDaysToNextBirthday(birthDate) {
    const today = new Date();
    const next = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());
    if (next < today) next.setFullYear(today.getFullYear() + 1);
    const diff = next - today;
    return Math.ceil(diff / (1000 * 60 * 60 * 24));
}

function getDaySuffix(days) {
    if (days % 10 === 1 && days % 100 !== 11) return "–¥–µ–Ω—å";
    if (days % 10 >= 2 && days % 10 <= 4 && (days % 100 < 10 || days % 100 >= 20)) return "–¥–Ω—è";
    return "–¥–Ω–µ–π";
}

function getNextBirthdayDate(birthDate) {
    const today = new Date();
    const next = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());
    if (next < today) next.setFullYear(today.getFullYear() + 1);
    return next.toLocaleDateString('ru-RU');
}

function viewEmployee(id, name, dob, dept) {
    const birthDate = new Date(dob);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const thisYear = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());
    if (thisYear > today) age--;

    const daysToNext = calculateDaysToNextBirthday(birthDate);
    const formattedDate = birthDate.toLocaleDateString('ru-RU');
    const initials = name.split(' ').length > 1 ? name.split(' ')[0][0] + name.split(' ')[1][0] : name[0];

    const html = `
        <div class="text-center mb-4">
            <div class="employee-avatar mx-auto mb-3" style="width: 80px; height: 80px; font-size: 24px;">
                ${initials}
            </div>
            <h4>${name}</h4>
            <div class="text-muted">${dept ? dept : "‚Äî –±–µ–∑ –æ—Ç–¥–µ–ª–∞ ‚Äî"}</div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label text-muted">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                    <div class="form-control bg-light">${formattedDate}</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label text-muted">–í–æ–∑—Ä–∞—Å—Ç</label>
                    <div class="form-control bg-light">${age} ${getAgeSuffix(age)}</div>
                </div>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label text-muted">–û—Ç–¥–µ–ª</label>
            <div class="form-control bg-light">${dept ? dept : "‚Äî"}</div>
        </div>

        <div class="mb-3">
            <label class="form-label text-muted">–î–Ω–µ–π –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è —Ä–æ–∂–¥–µ–Ω–∏—è</label>
            <div class="form-control bg-light">
                ${daysToNext} ${getDaySuffix(daysToNext)}
            </div>
        </div>

        <div class="alert alert-info mt-3">
            <i class="bi bi-info-circle"></i>
            <small>–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è: ${getNextBirthdayDate(birthDate)}</small>
        </div>
    `;

    document.getElementById('employeeDetails').innerHTML = html;

    document.getElementById('editFromModal').onclick = function () {
        editEmployee(id);
        bootstrap.Modal.getInstance(document.getElementById('viewEmployeeModal')).hide();
    };

    new bootstrap.Modal(document.getElementById('viewEmployeeModal')).show();
}

/* === Telegram test === */
function sendTestNotification() {
    fetch('/send_test_notification')
        .then(r => r.json())
        .then(d => {
            if (d.success) showAlert('–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!', 'success');
            else showAlert('–û—à–∏–±–∫–∞: ' + d.error, 'danger');
        })
        .catch(() => showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'danger'));
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show shadow-sm fade-in`;
    alertDiv.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.dashboard-header').nextSibling);
    setTimeout(() => alertDiv.remove(), 5000);
}

/* === –ö–Ω–æ–ø–∫–∏ –æ—Ç–¥–µ–ª–æ–≤ + —Ñ–∏–ª—å—Ç—Ä === */
function getRowDepartment(row) {
    // –í–∞–∂–Ω–æ: –æ—Ç–¥–µ–ª –≤ 6-–π –∫–æ–ª–æ–Ω–∫–µ (—Å–º. —Ç–∞–±–ª–∏—Ü—É: —á–µ–∫–±–æ–∫—Å, #, —Å–æ—Ç—Ä—É–¥–Ω–∏–∫, –¥–∞—Ç–∞, –≤–æ–∑—Ä–∞—Å—Ç, –æ—Ç–¥–µ–ª, –¥–µ–π—Å—Ç–≤–∏—è)
    const td = row.querySelector('td:nth-child(6)');
    if (!td) return "";
    const txt = td.innerText.trim();
    return (txt === "‚Äî" || txt === "") ? "–ë–µ–∑ –æ—Ç–¥–µ–ª–∞" : txt;
}

function buildDepartmentButtons() {
    const rows = Array.from(document.querySelectorAll('#employeeTableBody tr'));
    const deptMap = new Map();

    rows.forEach(r => {
        const dept = getRowDepartment(r);
        deptMap.set(dept, (deptMap.get(dept) || 0) + 1);
    });

    let depts = Array.from(deptMap.keys()).sort((a,b)=>a.localeCompare(b,'ru'));
    const idx = depts.indexOf("–ë–µ–∑ –æ—Ç–¥–µ–ª–∞");
    if (idx !== -1) { depts.splice(idx,1); depts.push("–ë–µ–∑ –æ—Ç–¥–µ–ª–∞"); }

    const container = document.getElementById('deptButtons');
    container.innerHTML = "";

    depts.forEach(dept => {
        const count = deptMap.get(dept);

        const btn = document.createElement('button');
        btn.type = "button";
        btn.className = "btn btn-sm btn-outline-light";
        btn.setAttribute('data-dept', dept);
        btn.onclick = () => filterByDepartment(dept);

        btn.innerHTML = `${dept} <span class="badge bg-light text-dark ms-1">${count}</span>`;
        container.appendChild(btn);
    });
}

function setActiveDeptButton(dept) {
    document.querySelectorAll('#deptButtons button').forEach(b => {
        b.classList.remove('btn-light');
        b.classList.add('btn-outline-light');
    });
    if (dept === "ALL") return;
    const active = document.querySelector(`#deptButtons button[data-dept="${CSS.escape(dept)}"]`);
    if (active) {
        active.classList.remove('btn-outline-light');
        active.classList.add('btn-light');
    }
}

function filterByDepartment(dept) {
    const rows = Array.from(document.querySelectorAll('#employeeTableBody tr'));
    let visible = 0;

    rows.forEach(r => {
        const rowDept = getRowDepartment(r);
        const show = (dept === "ALL") ? true : (rowDept === dept);
        r.style.display = show ? "" : "none";
        if (show) visible++;
    });

    const label = document.getElementById('currentFilterLabel');
    if (label) label.textContent = (dept === "ALL") ? "–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏" : `–û—Ç–¥–µ–ª: ${dept} (–ø–æ–∫–∞–∑–∞–Ω–æ ${visible})`;

    setActiveDeptButton(dept);
}

document.addEventListener('DOMContentLoaded', function() {
    buildDepartmentButtons();
    filterByDepartment("ALL");

    // –ö–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ —Ç–∞–±–ª–∏—Ü—ã (–∫—Ä–æ–º–µ —á–µ–∫–±–æ–∫—Å–∞ –∏ –∫–Ω–æ–ø–æ–∫)
    document.querySelectorAll('.employee-row').forEach(row => {
        row.addEventListener('click', function(e) {
            if (!e.target.closest('input[type="checkbox"]') && !e.target.closest('.action-buttons')) {
                const id = this.getAttribute('data-id');
                const name = this.querySelector('td:nth-child(3) strong').textContent;
                const dob = this.querySelector('td:nth-child(4) small').textContent;
                const dept = this.querySelector('td:nth-child(6)').innerText.trim();
                viewEmployee(id, name, dob, dept === "‚Äî" ? "" : dept);
            }
        });
    });
});
</script>
</body>
</html>
